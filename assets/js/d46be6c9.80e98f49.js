"use strict";(self.webpackChunkgravity_doc=self.webpackChunkgravity_doc||[]).push([[750],{6819:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>d,metadata:()=>o,toc:()=>a});var t=s(4848),r=s(8453);const d={},i="MongoDB Adapter",o={id:"config/adapter-config/mongodb",title:"MongoDB Adapter",description:"Requirements",source:"@site/docs/config/adapter-config/mongodb.md",sourceDirName:"config/adapter-config",slug:"/config/adapter-config/mongodb",permalink:"/docs/config/adapter-config/mongodb",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"docSidebar",previous:{title:"MySQL Adapter",permalink:"/docs/config/adapter-config/mysql"},next:{title:"Informix DB Adapter",permalink:"/docs/config/adapter-config/informix"}},c={},a=[{value:"Requirements",id:"requirements",level:2},{value:"<code>config.toml</code> Explanation",id:"configtoml-explanation",level:2},{value:"Example of <code>configs/config.toml</code>",id:"example-of-configsconfigtoml",level:5},{value:"<code>settings.json</code> Explanation",id:"settingsjson-explanation",level:2},{value:"Example of <code>settings/sources.json</code>",id:"example-of-settingssourcesjson",level:5},{value:"Build",id:"build",level:2},{value:"Deploy MongoDB Replica Set Using Docker",id:"deploy-mongodb-replica-set-using-docker",level:2},{value:"Start MongoDB Instances",id:"start-mongodb-instances",level:3},{value:"Initiate the Replica Set",id:"initiate-the-replica-set",level:3},{value:"Test and Verify the Replica Set",id:"test-and-verify-the-replica-set",level:3},{value:"Deploy <code>gravity-adapter-mongodb</code> on Kubernetes",id:"deploy-gravity-adapter-mongodb-on-kubernetes",level:2},{value:"Deploy the Adapter",id:"deploy-the-adapter",level:3},{value:"Enable MongoDB TLS Connections",id:"enable-mongodb-tls-connections",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h5:"h5",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"mongodb-adapter",children:"MongoDB Adapter"})}),"\n",(0,t.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"MongoDB version 3.6 and higher."}),"\n",(0,t.jsxs)(n.li,{children:["MongoDB must be in ",(0,t.jsx)(n.strong,{children:"replica set"})," or ",(0,t.jsx)(n.strong,{children:"shard mode"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.h2,{id:"configtoml-explanation",children:[(0,t.jsx)(n.code,{children:"config.toml"})," Explanation"]}),"\n",(0,t.jsxs)(n.h5,{id:"example-of-configsconfigtoml",children:["Example of ",(0,t.jsx)(n.code,{children:"configs/config.toml"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'[gravity]\ndomain = "default"\nhost = "localhost"\nport = 4222\npingInterval = 10\nmaxPingsOutstanding = 3\nmaxReconnects = -1\naccessToken = ""\npublishBatchSize = 1000\nrateLimit = 0\n\n[adapter]\nadapterID = "mongodb_adapter"\nadapterName = "Mongodb Adapter"\n\n[source]\nconfig = "./settings/sources.json"\n\n[store]\nenabled = true\npath = "./statestore"\n'})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.domain"})}),(0,t.jsx)(n.td,{children:"Sets the Gravity domain"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.host"})}),(0,t.jsx)(n.td,{children:"Sets the Gravity NATS IP address"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.port"})}),(0,t.jsx)(n.td,{children:"Sets the Gravity NATS port"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.pingInterval"})}),(0,t.jsx)(n.td,{children:"Sets the Gravity ping interval"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.maxPingsOutstanding"})}),(0,t.jsx)(n.td,{children:"Sets the maximum outstanding pings"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.maxReconnects"})}),(0,t.jsx)(n.td,{children:"Sets the maximum number of reconnections"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.accessToken"})}),(0,t.jsx)(n.td,{children:"Sets the Gravity access token (for authentication)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.publishBatchSize"})}),(0,t.jsx)(n.td,{children:"Sets the batch size for events sent to NATS"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"gravity.rateLimit"})}),(0,t.jsx)(n.td,{children:"Sets the maximum rate (per second) for events sent to NATS (0 = no limit)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"source.config"})}),(0,t.jsx)(n.td,{children:"Path to the source configuration file"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"store.enabled"})}),(0,t.jsx)(n.td,{children:"Enables persistent volume mounting (for state storage)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"store.path"})}),(0,t.jsx)(n.td,{children:"Path for mounting the persistent volume"})]})]})]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"INFO"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"config.toml"})," settings can also be provided via environment variables. The naming convention is as follows:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"GRAVITY_ADAPTER_MONGODB_[SECTION]_[KEY]\n"})}),"\n",(0,t.jsxs)(n.p,{children:["All letters are uppercase, and underscores (",(0,t.jsx)(n.code,{children:"_"}),") separate the sections and keys.",(0,t.jsx)(n.br,{}),"\n","Example for ",(0,t.jsx)(n.code,{children:"gravity.host"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"env:\n- name: GRAVITY_ADAPTER_MONGODB_GRAVITY_HOST\n  value: 192.168.0.1\n"})}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.h2,{id:"settingsjson-explanation",children:[(0,t.jsx)(n.code,{children:"settings.json"})," Explanation"]}),"\n",(0,t.jsxs)(n.h5,{id:"example-of-settingssourcesjson",children:["Example of ",(0,t.jsx)(n.code,{children:"settings/sources.json"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "sources": {\n    "my_mongo": {\n      "disabled": false,\n      "uri": "mongodb://mongodb-0:27017,mongodb-1:27017,mongodb-2:27017/?replicaSet=mongodb&tls=true",\n      "ca_file": "rootCA.pem",\n      "username": "admin",\n      "password": "1qaz@WSX",\n      "authSource": "admin",\n      "dbname": "admin",\n      "initialLoad": false,\n      "tables": {\n        "account": {\n          "events": {\n            "//comment": "snapshot events are not supported; initialLoad events are create, update, and delete",\n            "create": "accountCreated",\n            "update": "accountUpdated",\n            "delete": "accountDeleted"\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.disabled"})}),(0,t.jsx)(n.td,{children:"Whether to disable this source"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.uri"})}),(0,t.jsxs)(n.td,{children:["MongoDB connection URI. See ",(0,t.jsx)(n.a,{href:"https://www.mongodb.com/docs/drivers/go/current/fundamentals/connections/connection-guide/#connection-uri",children:"Connection URI"})," for details."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.ca_file"})}),(0,t.jsxs)(n.td,{children:["Path to the CA certificate when ",(0,t.jsx)(n.code,{children:"tls=true"})," is enabled"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.username"})}),(0,t.jsx)(n.td,{children:"MongoDB login username"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.password"})}),(0,t.jsx)(n.td,{children:"MongoDB login password"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.authSource"})}),(0,t.jsx)(n.td,{children:"Database for user authentication"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.dbname"})}),(0,t.jsx)(n.td,{children:"MongoDB database name"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.initialLoad"})}),(0,t.jsx)(n.td,{children:"Whether to synchronize existing records during initialization"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.tables.COLLECTION_NAME"})}),(0,t.jsx)(n.td,{children:"Name of the MongoDB collection to capture events"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.tables.COLLECTION_NAME.event.create"})}),(0,t.jsx)(n.td,{children:"Event name for record creation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.tables.COLLECTION_NAME.event.update"})}),(0,t.jsx)(n.td,{children:"Event name for record updates"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"sources.SOURCE_NAME.tables.COLLECTION_NAME.event.delete"})}),(0,t.jsx)(n.td,{children:"Event name for record deletion"})]})]})]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"INFO"})}),"\n",(0,t.jsxs)(n.p,{children:["Database passwords can be provided via environment variables using AES encryption.",(0,t.jsx)(n.br,{}),"\n","Example format:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[SOURCE_NAME]_PASSWORD\n"})}),"\n",(0,t.jsx)(n.p,{children:"Kubernetes example using a secret:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"env:\n- name: MONGODB_SOURCE_PASSWORD\n  valueFrom:\n    secretKeyRef:\n      name: mongodb-password\n      key: db_source_mongodb_password\n"})}),"\n",(0,t.jsx)(n.p,{children:"Secret definition:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: mongodb-password\ntype: Opaque\nstringData:\n  db_source_mongodb_password: 8e5ca8439ddebbac9bf2b83caf4bef7a\n"})}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"build",children:"Build"}),"\n",(0,t.jsx)(n.p,{children:"To build the adapter image, use the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'podman buildx build --platform linux/amd64 --build-arg="AES_KEY=**********" -t hb.k8sbridge.com/gravity/gravity-adapter-mongodb:v2.0.0 -f build/docker/Dockerfile .\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"deploy-mongodb-replica-set-using-docker",children:"Deploy MongoDB Replica Set Using Docker"}),"\n",(0,t.jsx)(n.h3,{id:"start-mongodb-instances",children:"Start MongoDB Instances"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"docker run -d --name mongo1 -p 27017:27017 mongo --replSet rs0 --bind_ip_all\n"})}),"\n",(0,t.jsx)(n.h3,{id:"initiate-the-replica-set",children:"Initiate the Replica Set"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'docker exec -it mongo1 mongosh --eval "rs.initiate({\n _id: \\"rs0\\",\n members: [\n   {_id: 0, host: \\"mongo1\\"}\n ]\n})"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"test-and-verify-the-replica-set",children:"Test and Verify the Replica Set"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'docker exec -it mongo1 mongosh --eval "rs.status()"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.h2,{id:"deploy-gravity-adapter-mongodb-on-kubernetes",children:["Deploy ",(0,t.jsx)(n.code,{children:"gravity-adapter-mongodb"})," on Kubernetes"]}),"\n",(0,t.jsx)(n.h3,{id:"deploy-the-adapter",children:"Deploy the Adapter"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Modify ",(0,t.jsx)(n.code,{children:"GRAVITY_ADAPTER_MONGODB_SOURCE_SETTINGS"})," in ",(0,t.jsx)(n.code,{children:"samples/gravity-adapter-mongodb.yaml"})," with the desired settings."]}),"\n",(0,t.jsxs)(n.li,{children:["Apply the configuration:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace <my-namespace> apply -f samples/gravity-adapter-mongodb.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Verify deployment:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace <my-namespace> get pods\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"enable-mongodb-tls-connections",children:"Enable MongoDB TLS Connections"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create a config map for the CA certificate:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace <your-namespace> create configmap ca-config-map --from-file=ca.crt=<path-to-ca.crt>\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Modify ",(0,t.jsx)(n.code,{children:"samples/gravity-adapter-mongodb_tls.yaml"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add ",(0,t.jsx)(n.code,{children:"tls=true"})," to the connection URI."]}),"\n",(0,t.jsxs)(n.li,{children:["Set the ",(0,t.jsx)(n.code,{children:"ca_file"})," parameter to the certificate path."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Deploy:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace <my-namespace> apply -f samples/gravity-adapter-mongodb_tls.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Check logs for successful connection:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace <my-namespace> logs gravity-adapter-example-0\n"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>o});var t=s(6540);const r={},d=t.createContext(r);function i(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);